#!/usr/bin/env bash
#
# platypus - Sync Git monorepo with SVN and subrepos
#
# Copyright 2025 - Edgar Costa
#
# Platypus keeps three worlds in sync using a Git monorepo as the hub:
#   SVN <-> Git monorepo <-> Git subrepos
#
# Usage:
#   platypus <command> [options]
#
# Commands:
#   svn       Sync Git main to SVN
#   subtree   Manage Git subtrees (pull/push)
#   sync      Run full sync (SVN + subtrees)
#   help      Show this help message
#   version   Show version information
#

set -e

#------------------------------------------------------------------------------
# Configuration:
#------------------------------------------------------------------------------

VERSION=0.1.0

# Get the root directory of Platypus
# If PLATYPUS_ROOT is set (from .rc), use it; otherwise compute from script location
if [[ -z "${PLATYPUS_ROOT:-}" ]]; then
  # Get the directory where this script lives (resolving symlinks)
  SOURCE="${BASH_SOURCE[0]}"
  while [[ -L "$SOURCE" ]]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
  done
  SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  # Script is in lib/, so root is one level up
  PLATYPUS_ROOT="$(dirname "$SCRIPT_DIR")"
fi

LIB_DIR="$PLATYPUS_ROOT/lib"

#------------------------------------------------------------------------------
# Utility functions:
#------------------------------------------------------------------------------

say() {
  echo "$@"
}

err() {
  echo "$@" >&2
}

error() {
  echo "ERROR: $*" >&2
  exit 1
}

#------------------------------------------------------------------------------
# Help:
#------------------------------------------------------------------------------

show-help() {
  cat <<'EOF'
Usage: platypus <command> [options]

Platypus keeps three worlds in sync using a Git monorepo as the hub:
  SVN <-> Git monorepo <-> Git subtrees

Commands:
  svn       Sync Git main to SVN (push commits from Git to SVN)
  subtree   Manage Git subtrees (pull/push)
  sync      Run full sync (SVN + subtrees)
  help      Show this help message
  version   Show version information

Examples:
  platypus svn --verbose           # Sync to SVN with verbose output
  platypus svn --push-conflicts    # Push through conflicts
  platypus subtree pull mylib      # Pull a subtree from upstream
  platypus subtree push mylib      # Push a subtree to upstream
  platypus sync                    # Full sync

For command-specific help:
  platypus svn --help
  platypus subtree --help
EOF
}

show-version() {
  echo "platypus version $VERSION"
  # shellcheck disable=SC1091  # Dynamically sourced module files - path is constructed at runtime
  echo "  svn module: $(source "$LIB_DIR/platypus-svn" && echo "$VERSION")"
  # shellcheck disable=SC1091  # Dynamically sourced module files - path is constructed at runtime
  echo "  subtree module: $(source "$LIB_DIR/platypus-subtree" && echo "$VERSION")"
}

#------------------------------------------------------------------------------
# Command dispatch:
#------------------------------------------------------------------------------

command:svn() {
  # shellcheck disable=SC1091  # Dynamically sourced module file - path is constructed at runtime
  source "$LIB_DIR/platypus-svn"
  main "$@"
}

command:subtree() {
  # shellcheck disable=SC1091  # Dynamically sourced module file - path is constructed at runtime
  source "$LIB_DIR/platypus-subtree"
  main "$@"
}

command:sync() {
  say "=== Platypus Full Sync ==="
  say ""
  
  # Step 1: Sync SVN
  say ">>> Step 1: Sync to SVN"
  command:svn "$@"
  local svn_exit=$?
  
  say ""
  
  # Step 2: Sync subtrees
  say ">>> Step 2: Sync subtrees"
  say "[TODO] Subtree sync not yet implemented"
  local subtree_exit=0
  
  say ""
  say "=== Full Sync Complete ==="
  
  # Return worst exit code
  if [[ $svn_exit -ne 0 ]]; then
    exit $svn_exit
  fi
  exit $subtree_exit
}

#------------------------------------------------------------------------------
# Main:
#------------------------------------------------------------------------------

main() {
  if [[ $# -eq 0 ]]; then
    show-help
    exit 0
  fi

  local command=$1
  shift

  case "$command" in
    svn)
      command:svn "$@"
      ;;
    subtree)
      command:subtree "$@"
      ;;
    sync)
      command:sync "$@"
      ;;
    help|--help|-h)
      show-help
      ;;
    version|--version)
      show-version
      ;;
    *)
      error "Unknown command: $command. Use 'platypus help' for usage."
      ;;
  esac
}

#------------------------------------------------------------------------------
# Entry point:
#------------------------------------------------------------------------------

[[ ${BASH_SOURCE[0]} != "$0" ]] || main "$@"

