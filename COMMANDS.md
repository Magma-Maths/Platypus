# Platypus Commands Reference

This document explains the logic behind each Platypus command with diagrams
showing repository states before and after each operation.

## Table of Contents

- [Platypus Overview](#platypus-overview)
- [Subtree Commands](#subtree-commands)
  - [Configuration Tracking](#configuration-tracking)
  - [subtree create](#subtree-create) — Export existing directory to new upstream
  - [subtree init](#subtree-init) — Link existing directory to existing upstream
  - [subtree add](#subtree-add) — Add external repo as new subtree
  - [subtree pull](#subtree-pull)
  - [subtree push](#subtree-push)
  - [subtree sync](#subtree-sync)
- [SVN Commands](#svn-commands)
  - [svn pull](#svn-pull)
  - [svn push](#svn-push) — Export origin/main to SVN (no fetch/push)
  - [svn sync](#svn-sync) — Full workflow (fetch + push + origin push)
- [Common Scenarios](#common-scenarios)
  - [Divergent Histories](#divergent-histories)
  - [Conflict Resolution](#conflict-resolution)

## Platypus Overview

<!-- BEGIN platypus-help -->
<!-- The following help text block is automatically generated by scripts/update-commands-md from: /Users/edgarcosta/MIT Dropbox/Edgar/magma/Platypus/lib/platypus --help; do not edit this block manually. -->
```bash
Usage: platypus <command> [options]

Platypus keeps three worlds in sync using a Git monorepo as the hub:
  SVN <-> Git monorepo <-> Git subtrees

Commands:
  svn       Sync Git main to SVN (push commits from Git to SVN)
  subtree   Manage Git subtrees (pull/push)
  sync      Run full sync (SVN + subtrees)
  help      Show this help message
  version   Show version information

Examples:
  platypus svn --verbose           # Sync to SVN with verbose output
  platypus svn --push-conflicts    # Push through conflicts
  platypus subtree pull mylib      # Pull a subtree from upstream
  platypus subtree push mylib      # Push a subtree to upstream
  platypus sync                    # Full sync

For command-specific help:
  platypus svn --help
  platypus subtree --help

```
<!-- END platypus-help -->

Platypus is the command-line entry point for managing Git subtrees and syncing with SVN. The top-level CLI routes to `subtree` and `svn` subcommands and provides shared flags and version information.

---

## Subtree Commands

<!-- BEGIN platypus-subtree-help -->
<!-- The following help text block is automatically generated by scripts/update-commands-md from: /Users/edgarcosta/MIT Dropbox/Edgar/magma/Platypus/lib/platypus subtree --help; do not edit this block manually. -->
```bash
Usage: platypus subtree <command> [options]

Manage Git subtrees in the monorepo. Configuration is stored in .gitsubtrees
at the repository root (similar to .gitmodules).

Commands:
  create <prefix> <upstream> [-b <branch>]
                    Export existing directory to a new upstream repo
  init <prefix> [-r <remote>] [-b <branch>]
                    Link existing directory to an existing upstream
  add <prefix> <repo> [<ref>]
                    Add a new subtree from a remote repository
  pull <prefix>     Pull upstream changes into subtree
  push <prefix>     Push subtree changes to upstream
  sync <prefix>     Bidirectional sync (pull then push)
  status [<prefix>] Show sync status of subtree(s)
  list              List all configured subtrees

Options:
  -h, --help        Show this help message
  -v, --verbose     Show verbose output
  -q, --quiet       Suppress normal output
  -n, --dry-run     Show what would be done without doing it
  -d, --debug       Show debug output
  --version         Show version information

For create/init commands:
  -b, --branch      Remote branch (default: main)
  -r, --remote      Remote repository URL (init only)

Examples:
  # Export existing lib/foo to a new upstream repo
  platypus subtree create lib/foo git@github.com:owner/foo.git

  # Link existing lib/foo to an existing upstream
  platypus subtree init lib/foo -r git@github.com:owner/foo.git

  # Add a new subtree from a remote
  platypus subtree add lib/bar git@github.com:owner/bar.git main

  # Pull upstream changes
  platypus subtree pull lib/foo

  # Push local changes to upstream
  platypus subtree push lib/foo

  # Bidirectional sync (pull then push)
  platypus subtree sync lib/foo

  # Show status of all subtrees
  platypus subtree status

Configuration file (.gitsubtrees):
  [subtree "lib/foo"]
      remote = git@github.com:owner/foo.git
      branch = main
      upstream = <last synced upstream commit>
      preMergeParent = <monorepo commit before last sync>
      splitSha = <last split SHA for incremental push>

```
<!-- END platypus-subtree-help -->

Subtree commands manage Git subtrees - embedding external repositories as
subdirectories in your monorepo. Configuration is stored in `.gitsubtrees`.

### Conceptual Overview (SVN)

```text
┌─────────────────────────────────────────────────────────────────────┐
│                          MONOREPO                                   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  README.md                                                   │   │
│  │  src/                                                        │   │
│  │  lib/                                                        │   │
│  │  └── foo/  ◄─── SUBTREE (from upstream repo)                 │   │
│  │       ├── file.txt                                           │   │
│  │       └── lib-file.txt                                       │   │
│  │  .gitsubtrees  ◄─── Configuration file                       │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                              ▲
                              │ pull/push
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       UPSTREAM REPO                                 │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  file.txt                                                    │   │
│  │  lib-file.txt                                                │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

### Configuration Tracking

The `.gitsubtrees` file tracks three important SHA values for each subtree:

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = abc123...         # Last synced upstream commit
    preMergeParent = def456... # Monorepo commit BEFORE last sync  
    splitSha = 789abc...         # Last split result (for incremental push)
```

| Field | Purpose | Set By |
|-------|---------|--------|
| `upstream` | Points to the upstream repo commit we last synced with | `create`, `init`, `add`, `pull` |
| `preMergeParent` | Points to the monorepo commit BEFORE the sync operation | `create`, `init`, `add`, `pull`, `push` |
| `splitSha` | Points to the extracted subtree history branch tip | `create`, `push` |

**Command Summary:**

| Command | Use Case | Creates Dir? | Establishes Merge Base? |
|---------|----------|--------------|------------------------|
| `create` | Export existing dir to new upstream | No | Yes (via split --rejoin) |
| `init` | Link existing dir to existing upstream | No | Yes (via merge) |
| `add` | Add external repo as new subtree | Yes | Yes (via subtree add) |

**Why track these?**

- `upstream`: Tells us "what upstream commit is our subtree based on?" Used to detect if upstream has new changes.
- `preMergeParent`: Tells us "where was the monorepo before this sync?" This is a **stable reference** that doesn't change when we amend the merge commit to include config. Used for detecting new changes since last sync.
- `splitSha`: Enables **incremental push optimization**. Without it, `git subtree split` must walk the entire repo history. With it, we can use `--rejoin` to mark split points, making subsequent splits much faster.

---

### subtree create

**Purpose:** Export an existing directory to a new upstream repository.

**Use Case:** You have a directory in your monorepo (e.g., from SVN migration) and want
to make it available as a standalone repository for external contributors.

**Usage:**

```bash
platypus subtree create <prefix> <upstream> [-b <branch>]
```

**What it does:**

1. Validates the directory exists
2. Tests that the upstream repository is accessible
3. Runs `git subtree split --prefix --rejoin` to extract history and create merge base
4. Pushes the split branch to the upstream repository
5. Creates configuration in `.gitsubtrees`
6. Amends the rejoin commit to include config

**Before:**

```text
Mono:     A ─── B ─── C (contains lib/foo directory)
                                                     
Upstream: (empty repo, waiting for content)          
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (split --rejoin merge)
                           ╱
                    X ────┘  (extracted lib/foo history)
                    │
Upstream:           X        (pushed to upstream)

Config: upstream=X, preMergeParent=C, splitSha=X
```

**Config state after `create`:**

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = X              # ← The split/pushed commit
    preMergeParent = C      # ← Mono commit BEFORE the rejoin
    splitSha = X              # ← Same as upstream (enables incremental push)
```

---

### subtree init

**Purpose:** Link an existing directory to an existing upstream repository.

**Use Case:** The directory already has content, and there's an existing upstream repo
(perhaps already set up by someone else). This establishes the merge base so future
pulls work correctly.

**Usage:**

```bash
platypus subtree init <prefix> [-r <remote>] [-b <branch>]
```

**What it does:**

1. Validates the directory exists
2. Fetches from the upstream repository
3. Merges with `--allow-unrelated-histories` to establish subtree relationship
4. Creates configuration in `.gitsubtrees`
5. Amends the merge commit to include config

**Before:**

```text
Mono:     A ─── B ─── C (contains lib/foo, unrelated to upstream)
                                                     
Upstream: X ─── Y ─── Z (existing upstream content)
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (Merge to establish relationship)
                           ╱
Upstream: X ─── Y ─── Z ──┘

Config: upstream=Z, preMergeParent=C, splitSha=(none)
```

**Config state after `init`:**

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = Z              # ← Current upstream tip
    preMergeParent = C      # ← Mono commit BEFORE the merge
    splitSha = (none)         # ← Not set until first push
```

---

### subtree add

**Purpose:** Add a new subtree from a remote repository (creates the directory).

**Use Case:** You want to incorporate an external repository as a subdirectory in your
monorepo. The directory doesn't exist yet - it will be created with the upstream content.

**Usage:**

```bash
platypus subtree add <prefix> <repo> [<ref>]
```

**What it does:**

1. Fetches the remote repository
2. Adds the content at the specified prefix using `git subtree add`
3. Creates configuration in `.gitsubtrees`
4. Records the upstream commit SHA for tracking

**Before:**

```text
Mono:     A ─────────────────────────────────────
                                                  
Upstream: X (content we want)                     
```

**After:**

```text
Mono:     A ───── B (Add lib/foo subtree)
                 /
Upstream: X ────┘
```

**Config state after `add`:**

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = X              # ← The upstream commit we added
    preMergeParent = A      # ← Mono commit BEFORE the merge (stable!)
    splitSha = (none)         # ← Not set until first push
```

---

### subtree pull

**Purpose:** Pull upstream changes into the subtree.

**Usage:**

```bash
platypus subtree pull <prefix>
```

**What it does:**

1. Fetches from the configured remote
2. Merges upstream changes into the subtree prefix using `git subtree merge`
3. Updates the `upstream` and `parent` config values
4. Amends the merge commit to include config changes

**Before:**

```text
Mono:     A ─── B ─── C (mono work)
             ╱
Upstream: X ─── Y ─── Z (new commits)

Config: upstream=X, preMergeParent=A, splitSha=(none)
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (Merge subtree from Z)
             ╱             ╱
Upstream: X ─── Y ─── Z ──┘

Config: upstream=Z, preMergeParent=C, splitSha=(none)
                 ▲                   ▲
                 │                   └── Captured BEFORE the merge (stable!)
                 └── Updated to fetched upstream tip
```

The merge commit D contains:

- All files from Z in the `lib/foo/` prefix
- Updated `.gitsubtrees` with new `upstream` and `preMergeParent` SHAs

**Config changes:**

| Field | Before | After |
|-------|--------|-------|
| `upstream` | X | Z (new upstream tip) |
| `preMergeParent` | A | C (mono HEAD before merge) |
| `splitSha` | (none) | (unchanged) |

---

### subtree push

**Purpose:** Push local subtree changes to the upstream repository.

**Usage:**

```bash
platypus subtree push <prefix>
```

**What it does:**

1. Runs `git subtree split --rejoin` to extract subtree history
2. Pushes the split branch to the upstream remote
3. Records the `splitSha` for incremental optimization
4. Amends the rejoin commit to include config update

**Before:**

```text
Mono:     A ─── B ─── C (changed lib/foo/file.txt)
             ╱
Upstream: X ───────────

Config: upstream=X, preMergeParent=B, splitSha=(none)
```

**The split operation extracts subtree commits:**

```text
Full mono history:        Extracted subtree history:
A ─── B ─── C             X ─── C' (just the lib/foo changes)
     ╱                         │
    X                          └── This becomes splitSha
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (rejoin merge)
             ╱             ╲
Upstream: X ─────────────── C' (pushed)
                            │
                            └── splitSha points here

Config: upstream=X, preMergeParent=C, splitSha=C'
                                    ▲            ▲
                                    │            └── NEW: tracks split result
                                    └── Captured BEFORE rejoin (stable!)
```

The `--rejoin` creates a merge commit marking where we split. This makes
subsequent pushes faster because `git subtree split` can skip already-processed history.

**Config changes:**

| Field | Before | After |
|-------|--------|-------|
| `upstream` | X | X (unchanged - we pushed TO upstream, not pulled) |
| `preMergeParent` | B | C (mono HEAD before rejoin) |
| `splitSha` | (none) | C' (the extracted subtree branch tip) |

**Why splitSha matters:**

Without splitSha tracking (first push):

```bash
git subtree split --prefix=lib/foo
# Must walk ENTIRE repo history to find subtree commits
# On a 50k commit repo, this can take minutes
```

With splitSha tracking (subsequent pushes):

```bash
git subtree split --prefix=lib/foo --rejoin
# The --rejoin merge commit marks the split point
# Subsequent splits only process new commits
# Takes seconds instead of minutes
```

---

### subtree sync

**Purpose:** Bidirectional sync - pull then push.

**Usage:**

```bash
platypus subtree sync <prefix>
```

**What it does:**

1. Executes `subtree pull` (get upstream changes)
2. Executes `subtree push` (send local changes)

This is useful when both the monorepo and upstream have new commits.

**Before (divergent state):**

```text
Mono:     A ─── B ─── C (mono change)
             ╱
Upstream: X ─── Y (upstream change)

Config: upstream=X, preMergeParent=A, splitSha=(none)
```

**After pull phase:**

```text
Mono:     A ─── B ─── C ─── D (merge from upstream)
             ╱             ╱
Upstream: X ─── Y ────────┘

Config: upstream=Y, preMergeParent=C, splitSha=(none)
```

**After push phase:**

```text
Mono:     A ─── B ─── C ─── D ─── E (rejoin)
             ╱             ╱     ╲
Upstream: X ─── Y ────────┴───── C' (mono change pushed)
                                  │
                                  └── splitSha

Config: upstream=Y, preMergeParent=D, splitSha=C'
```

**Full config evolution during sync:**

| Phase | upstream | preMergeParent | splitSha |
|-------|----------|------------------|----------|
| Before | X | A | (none) |
| After pull | Y | C | (none) |
| After push | Y | D | C' |

After sync, both repos have all changes:

- Upstream has: X → Y → C' (both upstream's Y and mono's C)
- Mono has: merged Y from upstream, plus its own C

---

## SVN Commands

<!-- BEGIN platypus-svn-help -->
<!-- The following help text block is automatically generated by scripts/update-commands-md from: /Users/edgarcosta/MIT Dropbox/Edgar/magma/Platypus/lib/platypus svn --help; do not edit this block manually. -->
```bash
Usage: platypus svn <command> [options]

Sync Git main branch to SVN without rewriting Git history.

Commands:
  pull              Pull latest changes from SVN into local mirror
  push              Export origin/main commits to SVN and merge back (fetches origin, no git push)
  sync              Full workflow: fetch origin, export to SVN, push origin
  --continue        Resume after resolving a conflict
  --abort           Abort in-progress operation and clean up

Options:
  -h, --help         Show this help message
  -v, --verbose      Show verbose step-by-step output
  -q, --quiet        Suppress normal output
  -n, --dry-run      Don't push to SVN or update marker
  -d, --debug        Show git commands as they are executed
  -x                 Turn on Bash debugging (set -x)
  --push-conflicts   Continue through conflicts, push with conflict markers
  --version          Show version information

Environment Variables:
  REMOTE          Git remote name (default: origin)
  MAIN            Main branch to sync from (default: main)
  MARKER          Marker branch for tracking progress (default: svn-marker)
  SVN_REMOTE_REF  git-svn tracking ref (default: refs/remotes/git-svn)
  SVN_BRANCH      Local SVN mirror branch (default: svn)
  EXPORT_BRANCH   Temporary svn-export branch (default: svn-export)
  CONFLICT_LOG    Conflict log file (default: .git/platypus/svngit/conflicts.log)

Exit Codes:
  0   Success - no conflicts
  1   Error - operation failed
  2   Success with conflicts - needs attention

Conflict Tracking (for automation):
  - Commits with conflicts are prefixed with [CONFLICT] in commit messages
  - Git notes are added to commits that had conflicts
  - Conflicts are logged to CONFLICT_LOG file

Examples:
  # Pull latest SVN changes
  platypus svn pull

  # Push Git commits to SVN (auto-fetches origin)
  platypus svn push --verbose

  # Full workflow (fetch + SVN export + push origin)
  platypus svn sync --verbose
  platypus svn sync --debug --dry-run
  platypus svn sync --push-conflicts

  # With custom environment
  REMOTE=upstream MAIN=master platypus svn sync

Automation example:
  platypus svn sync --push-conflicts --quiet
  case $? in
    0) echo "Success" ;;
    1) echo "Error" ;;
    2) echo "Conflicts need review" ;;
  esac

```
<!-- END platypus-svn-help -->

SVN commands sync the Git monorepo with an SVN repository using `git-svn`.
Changes flow: Git → SVN, and SVN metadata flows back into Git.

### Quick start (SVN)

Source is always the cached `origin/main`; run `git fetch origin` if you need the latest before exporting.

```bash
# Manual control (SVN only, you push origin yourself)
git fetch origin
platypus svn push
git push origin main

# One-shot (full workflow)
platypus svn sync
```

#### First sync scenarios

- Fresh git-svn init, origin/main empty or only SVN mirror:
  - `git svn init <svn-url>`; `git svn fetch`
  - `git switch -C svn refs/remotes/git-svn`
  - `git switch -C main svn` (if empty) and push once: `git push origin main`
  - `git fetch origin`; run `platypus svn push` (or `platypus svn sync`)

- Fresh git-svn init, origin/main already has commits:
  - `git svn init <svn-url>`; `git svn fetch`
  - `git switch -C svn refs/remotes/git-svn`
  - Optionally merge `svn` into `main` if you need SVN tip included, then push
  - `git fetch origin`; run `platypus svn push` (or `platypus svn sync`)

### Push vs sync at a glance

| Command | Fetch origin | SVN export | Local merge | Push origin | Best for |
|---------|:------------:|:----------:|:-----------:|:-----------:|----------|
| `svn push` | - | ✓ | ✓ | - | CI with pre-fetch, manual control |
| `svn sync` | ✓ | ✓ | ✓ | ✓ | One-command convenience |

### Conceptual Overview

```text
┌────────────────────────────────────────────────────────────────────────┐
│                              GIT                                        │
│                                                                         │
│   origin/main ──────────────────────────────────────────► TIP          │
│                                                                         │
│   origin/svn-marker ──► Last exported commit                           │
│                                                                         │
│   svn branch ──────────────────────────────────────────► SVN mirror    │
│                         (tracks refs/remotes/git-svn)                   │
└────────────────────────────────────────────────────────────────────────┘
                              │
                              │ git svn dcommit / rebase
                              ▼
┌────────────────────────────────────────────────────────────────────────┐
│                              SVN                                        │
│                                                                         │
│   trunk ─────────────────────────────────────────────────────────────  │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

---

### svn pull

**Purpose:** Pull latest changes from SVN into the local mirror.

**Usage:**

```bash
platypus svn pull
```

**What it does:**

1. Fetches latest state from the Git remote (for marker tracking)
2. Pulls latest SVN changes using `git svn rebase`
3. Reports how many commits are pending to push

**Before:**

```text
Git main:   A ─── B ─────────────────────
                                          
SVN mirror: A ───────────────────────────
                                          
SVN trunk:  r1 ─── r2 (new SVN commit)   
```

**After:**

```text
Git main:   A ─── B ─────────────────────
                                          
SVN mirror: A ─── C (from r2) ───────────
                  │                       
                  └── git svn rebase pulled this
                                          
SVN trunk:  r1 ─── r2                    
```

The `svn` branch now has the new SVN revision as a Git commit.

---

### svn push

**Purpose:** Export commits from `origin/main` to SVN and merge back locally. Auto-fetches origin; does not push to origin.

**Usage:**

```bash
platypus svn push [--push-conflicts]
```

**What it does:**

1. Fetches latest `origin/main`
2. Updates the SVN mirror (`git svn rebase`)
3. Ensures the marker branch exists
4. Builds the export plan (first-parent only)
5. Applies each commit to the export branch, preserving metadata (handles conflicts)
6. Runs `git svn dcommit` to push to SVN
7. Advances the marker branch
8. Merges SVN changes back into `main`
9. Returns you to your original branch

**Notes:**

- Auto-fetches `origin/main` at the start
- Does **not** push to origin; run `git push origin main` yourself after review

**Why first-parent only?**

When you have subtrees, their history lives "behind" merge commits:

```text
main (first-parent path): A ─── B ─── C
                                │
                                └──┬── L1 ─── L2 (subtree history)
                                   │
                                   └── subtree merge brings in L1, L2
```

Walking `--first-parent` gives: A → B → C (3 commits)
Walking all parents gives: A → B → L1 → L2 → C (5 commits)

We only want to export the net changes, not replay subtree internal history.

**Before:**

```text
Git main:   A ─── B ─── C ──────────────── (marker at A)
                                           
SVN trunk:  r1 ─────────────────────────── 
```

**After:**

```text
Git main:   A ─── B ─── C ─── D (merge SVN back)  (marker at C)
                             ╱                     
SVN trunk:  r1 ─── r2 ─── r3 ────────────────────
            │      │      │
            │      │      └── from C
            │      └── from B
            └── from A (initial)
```

The marker now points to C, and main has a merge commit with SVN metadata.

### svn sync

**Purpose:** Full workflow convenience: fetch origin, export to SVN, merge back, and push `main` to origin.

**Usage:**

```bash
platypus svn sync [--push-conflicts]
```

**What it does:**

1. Fetches latest `origin/main`
2. Runs the `svn push` pipeline described above
3. Pushes `main` to origin

**Typical workflow:**

```bash
platypus svn sync              # full automation
platypus svn sync --push-conflicts
```

#### Troubleshooting

- Origin push rejected (non-fast-forward):

```bash
git fetch origin
git rebase origin/main
git push origin main
```

- SVN dcommit race (left in rebase with conflicts):

```bash
git status           # fix conflicts
git add <files>
git rebase --continue
platypus svn push --continue
```

- Stale marker after rewritten history:

```bash
git push origin $(git merge-base origin/main svn):refs/heads/svn-marker --force
```

---

## Common Scenarios

### Divergent Histories

When both the monorepo and upstream have made changes since the last sync:

```text
Mono:     ... ─── B ─── C (mono adds feature)
                 │
                 └── last sync point
                 
Upstream: ... ─── X ─── Y (upstream fixes bug)
                 │
                 └── last sync point (same as B's subtree content)
```

**Resolution with `subtree sync`:**

1. **Pull phase** merges Y into mono:

   ```text
   Mono: ... ─── B ─── C ─── D (merge)
                            ╱
   Upstream: X ─── Y ──────┘
   ```

2. **Push phase** sends C to upstream:

   ```text
   Upstream: X ─── Y ─── C' (from mono's C)
   ```

After sync, both repos have both changes.

### Conflict Resolution

**Subtree conflicts:**

If pull creates conflicts:

```bash
platypus subtree pull lib/foo
# Conflict detected!
# Resolve manually, then:
git add <resolved-files>
git commit
```

**SVN conflicts:**

If push fails to apply a patch:

```bash
platypus svn push
# Patch apply failed!
# Options:
#   1. Fix manually and run: platypus svn push --continue
#   2. Abort: platypus svn push --abort
#   3. Force through: platypus svn push --push-conflicts
```

**SVN race condition:**

If someone else commits to SVN while you're pushing, `git svn dcommit` will fail
and leave you in a rebase state with conflicts:

```bash
platypus svn push
# SVN dcommit failed: someone else committed to SVN (race condition).
# You are now in a rebase state with conflicts.
# Options:
#   1. Resolve manually:
#      git status                      # See conflicted files
#      # ... fix conflicts ...
#      git add <files>                 # Stage fixes
#      git rebase --continue           # Complete rebase
#      platypus svn push --continue    # Resume push
#   2. Abort: platypus svn push --abort
#   3. Force through: platypus svn push --push-conflicts
```

The `--push-conflicts` option will:

- Apply patches with conflict markers where needed
- Automatically resolve dcommit race conditions by adding conflicts and continuing
- Prefix commit messages with `[CONFLICT]`
- Log conflicts to `.git/svngit-conflicts.log`
- Exit with code 2 (success with conflicts)

---

## Configuration Files

### .gitsubtrees

Tracks subtree configuration (like `.gitmodules` for submodules):

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = abc123...         # Last synced upstream commit
    preMergeParent = def456... # Monorepo commit BEFORE last sync
    splitSha = 789abc...         # Last split SHA (for incremental push)
```

**Config field lifecycle:**

```text
                    ┌───────────────────────────────────────────────────────────┐
                    │                Config Field Updates                       │
                    ├─────────────┬─────────────┬─────────────┬─────────────────┤
                    │   add       │   pull      │   push      │   sync          │
┌───────────────────┼─────────────┼─────────────┼─────────────┼─────────────────┤
│ upstream          │  SET        │  UPDATE     │  -          │  UPDATE         │
│ (upstream tip)    │  (fetched)  │  (fetched)  │             │  (pull phase)   │
├───────────────────┼─────────────┼─────────────┼─────────────┼─────────────────┤
│ preMergeParent    │  SET        │  UPDATE     │  UPDATE     │  UPDATE         │
│ (before merge)    │  (pre-add)  │  (pre-merge)│  (pre-join) │  (both phases)  │
├───────────────────┼─────────────┼─────────────┼─────────────┼─────────────────┤
│ splitSha          │  -          │  -          │  SET/UPDATE │  UPDATE         │
│ (split result)    │             │             │  (split)    │  (push phase)   │
└───────────────────┴─────────────┴─────────────┴─────────────┴─────────────────┘
```

### Environment Variables (SVN)

| Variable | Default | Description |
|----------|---------|-------------|
| `REMOTE` | `origin` | Git remote name |
| `MAIN` | `main` | Main branch to sync from |
| `MARKER` | `svn-marker` | Progress tracking branch |
| `SVN_REMOTE_REF` | `refs/remotes/git-svn` | git-svn tracking ref |
| `SVN_BRANCH` | `svn` | Local SVN mirror branch |
| `EXPORT_BRANCH` | `svn-export` | Temporary export branch |

---

## Command Quick Reference

| Command | Purpose |
|---------|---------|
| `platypus subtree add <prefix> <repo> [ref]` | Add new subtree |
| `platypus subtree pull <prefix>` | Pull upstream → mono |
| `platypus subtree push <prefix>` | Push mono → upstream |
| `platypus subtree sync <prefix>` | Pull then push |
| `platypus subtree status [prefix]` | Show sync status |
| `platypus subtree list` | List configured subtrees |
| `platypus svn pull` | Pull from SVN |
| `platypus svn push` | Export origin/main to SVN (no fetch/push origin) |
| `platypus svn sync` | Fetch origin, export to SVN, push origin |
| `platypus svn push --continue` | Resume after conflict |
| `platypus svn push --abort` | Abort in-progress push |
