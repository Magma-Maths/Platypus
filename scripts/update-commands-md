#!/usr/bin/env bash

set -euo pipefail

# Resolve repo root as the parent of this scripts/ directory
ROOT=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)

DOC_PLATYPUS="$ROOT/docs/platypus.md"
DOC_SUBTREE="$ROOT/docs/subtree.md"
DOC_SVN="$ROOT/docs/svn.md"

# You can override PLATYPUS_CMD in the environment if needed
PLATYPUS_CMD="${PLATYPUS_CMD:-$ROOT/lib/platypus}"

# Temp files used by update_block; kept global so EXIT trap sees them even after function returns
TMP_IN=""
TMP_OUT=""

# Helper: replace the content between BEGIN/END markers in a target file
# Arguments:
#   1: target file path
#   2: marker base name, e.g. "platypus-svn-help"
#   3..: command to generate the replacement text
update_block() {
  local target="$1"
  shift
  local marker="$1"
  shift
  local generator_cmd=("$@")
  local generator_str="${generator_cmd[*]}"

  # Use temp files and only replace the target on success to avoid truncation
  TMP_IN=$(mktemp "${target}.in.XXXX")
  TMP_OUT=$(mktemp "${target}.out.XXXX")
  trap 'rm -f "$TMP_IN" "$TMP_OUT"' EXIT

  # Run the command and capture help text
  local help_text
  # Ensure help runs without inherited PLATYPUS_ROOT to let the script self-resolve paths
  help_text="$(PLATYPUS_ROOT="" "$@" 2>&1)"

  # Work on a temp copy so we can do multiple blocks in one run
  cp "$target" "$TMP_IN"

  # Use Perl to replace the text between markers.
  # Format help text as a bash code block (like other sections in the docs)
  GEN_CMD="$generator_str" perl -0pe '
    BEGIN {
      $marker = shift @ARGV;
      $cmd = $ENV{GEN_CMD} // "";
      $help = do { local $/; <STDIN> };
      chomp $help;  # drop trailing newlines
      # Format with a plain-text generation notice before the bash fence
      $notice = "<!-- The following help text block is automatically generated by scripts/update-commands-md from: $cmd; do not edit this block manually. -->";
      $help = $notice . "\n```bash\n" . $help . "\n```";
    }

    my $begin = "<!-- BEGIN $marker -->";
    my $end   = "<!-- END $marker -->";

    my $idx_begin = index($_, $begin);
    die "BEGIN marker $begin not found\n" if $idx_begin < 0;
    my $idx_end = index($_, $end, $idx_begin);
    die "END marker $end not found\n" if $idx_end < 0;

    my $before = substr($_, 0, $idx_begin + length($begin));
    my $after  = substr($_, $idx_end);

    $_ = $before . "\n" . $help . "\n" . $after;
  ' "$marker" "$TMP_IN" <<< "$help_text" > "$TMP_OUT"

  mv "$TMP_OUT" "$target"
  rm -f "$TMP_IN"
  trap - EXIT
}

# Update each doc with its help block

update_block "$DOC_PLATYPUS" "platypus-help"         "$PLATYPUS_CMD" --help
update_block "$DOC_SUBTREE"  "platypus-subtree-help" "$PLATYPUS_CMD" subtree --help
update_block "$DOC_SVN"      "platypus-svn-help"     "$PLATYPUS_CMD" svn --help

