#!/usr/bin/env bash

set -euo pipefail

# Resolve repo root as the parent of this scripts/ directory
ROOT=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)

CMD_MD="$ROOT/COMMANDS.md"

# You can override PLATYPUS_CMD in the environment if needed
PLATYPUS_CMD="${PLATYPUS_CMD:-$ROOT/lib/platypus}"

# Helper: replace the content between BEGIN/END markers in $CMD_MD
# Arguments:
#   1: marker base name, e.g. "platypus-svn-help"
#   2..: command to generate the replacement text
update_block() {
  local marker="$1"
  shift
  local generator_cmd=("$@")
  local generator_str="${generator_cmd[*]}"

  # Use temp files and only replace the target on success to avoid truncation
  local tmp_in tmp_out
  tmp_in=$(mktemp "${CMD_MD}.in.XXXX")
  tmp_out=$(mktemp "${CMD_MD}.out.XXXX")
  trap 'rm -f "$tmp_in" "$tmp_out"' EXIT

  # Run the command and capture help text
  local help_text
  help_text="$("$@" 2>&1)"

  # Work on a temp copy so we can do multiple blocks in one run
  cp "$CMD_MD" "$tmp_in"

  # Use Perl to replace the text between markers.
  # Format help text as a bash code block (like other sections in COMMANDS.md)
  GEN_CMD="$generator_str" perl -0pe '
    BEGIN {
      $marker = shift @ARGV;
      $cmd = $ENV{GEN_CMD} // "";
      $help = do { local $/; <STDIN> };
      chomp $help;  # drop trailing newlines
      # Format with a plain-text generation notice before the bash fence
      $notice = "<!-- The following help text block is automatically generated by scripts/update-commands-md from: $cmd; do not edit this block manually. -->";
      $help = $notice . "\n```bash\n" . $help . "\n```";
    }

    my $begin = "<!-- BEGIN $marker -->";
    my $end   = "<!-- END $marker -->";

    my $idx_begin = index($_, $begin);
    die "BEGIN marker $begin not found\n" if $idx_begin < 0;
    my $idx_end = index($_, $end, $idx_begin);
    die "END marker $end not found\n" if $idx_end < 0;

    my $before = substr($_, 0, $idx_begin + length($begin));
    my $after  = substr($_, $idx_end);

    $_ = $before . "\n" . $help . "\n" . $after;
  ' "$marker" "$tmp_in" <<< "$help_text" > "$tmp_out"

  mv "$tmp_out" "$CMD_MD"
  rm -f "$tmp_in"
  trap - EXIT
}

# Update each block you care about:

update_block "platypus-help"         "$PLATYPUS_CMD" --help
update_block "platypus-subtree-help" "$PLATYPUS_CMD" subtree --help
update_block "platypus-svn-help"     "$PLATYPUS_CMD" svn --help

