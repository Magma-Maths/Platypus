#!/usr/bin/env bash
# Pre-commit check to prevent commits with test user credentials
#
# The test environment (test/test_helper.bash) exports GIT_AUTHOR_NAME and
# GIT_AUTHOR_EMAIL. If these are still set when making commits, git will use
# them instead of your configured git user.

set -euo pipefail

# Get the author from the commit being made
AUTHOR_NAME=$(git config user.name)
AUTHOR_EMAIL=$(git config user.email)

# Check if author is the test user
if [ "$AUTHOR_NAME" = "Test User" ] || [ "$AUTHOR_EMAIL" = "test@example.com" ]; then
    echo "ERROR: Attempting to commit with test user credentials!" >&2
    echo "Author: $AUTHOR_NAME <$AUTHOR_EMAIL>" >&2
    echo "" >&2
    echo "This usually happens when GIT_AUTHOR_NAME/GIT_AUTHOR_EMAIL environment" >&2
    echo "variables from tests are still set." >&2
    echo "" >&2
    echo "To fix:" >&2
    echo "  1. Unset the environment variables:" >&2
    echo "     unset GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL GIT_COMMITTER_NAME GIT_COMMITTER_EMAIL" >&2
    echo "     git config unset user.name" >&2
    echo "     git config unset user.email" >&2
    echo "  2. Or explicitly set the author:" >&2
    echo "     git commit --author='Your Name <your.email@example.com>' ..." >&2
    echo "" >&2
    exit 1
fi

exit 0

