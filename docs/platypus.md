# Platypus Overview and Common Topics

Platypus is the command-line entry point for managing Git subtrees and syncing with SVN. The top-level CLI routes to `subtree` and `svn` subcommands and provides shared flags and version information.

## Quick start

```bash
# Full SVN workflow (fetch, export to SVN, push origin)
platypus svn sync

# Export to SVN without pushing origin
platypus svn export

# Bidirectional subtree sync for a prefix
platypus subtree sync lib/foo

# Add a new subtree
platypus subtree add lib/foo git@github.com:owner/foo.git main
```

<!-- BEGIN platypus-help -->
<!-- The following help text block is automatically generated by scripts/update-commands-md from: /Users/edgarcosta/MIT Dropbox/Edgar/magma/Platypus/lib/platypus --help; do not edit this block manually. -->
```bash
Usage: platypus <command> [options]

Platypus keeps three worlds in sync using a Git monorepo as the hub:
  SVN <-> Git monorepo <-> Git subtrees

Commands:
  svn       Sync Git main to SVN (push commits from Git to SVN)
  subtree   Manage Git subtrees (pull/push)
  sync      Run full sync (SVN + subtrees)
  help      Show this help message
  version   Show version information

Examples:
  platypus svn --verbose           # Sync to SVN with verbose output
  platypus svn --push-conflicts    # Push through conflicts
  platypus subtree pull mylib      # Pull a subtree from upstream
  platypus subtree push mylib      # Push a subtree to upstream
  platypus sync                    # Full sync

For command-specific help:
  platypus svn --help
  platypus subtree --help

```
<!-- END platypus-help -->

---

## Common Scenarios

### Divergent Histories

When both the monorepo and upstream have made changes since the last sync:

```text
Mono:     ... ─── B ─── C (mono adds feature)
                 │
                 └── last sync point
                 
Upstream: ... ─── X ─── Y (upstream fixes bug)
                 │
                 └── last sync point (same as B's subtree content)
```

**Resolution with `subtree sync`:**

1. **Pull phase** merges Y into mono:

   ```text
   Mono: ... ─── B ─── C ─── D (merge)
                            ╱
   Upstream: X ─── Y ──────┘
   ```

2. **Push phase** sends C to upstream:

   ```text
   Upstream: X ─── Y ─── C' (from mono's C)
   ```

After sync, both repos have both changes.

### Conflict Resolution

**Subtree conflicts:**

If pull creates conflicts:

```bash
platypus subtree pull lib/foo
# Conflict detected!
# Resolve manually, then:
git add <resolved-files>
git commit
```

**SVN conflicts:**

If export fails to apply a patch:

```bash
platypus svn export
# Patch apply failed!
# Options:
#   1. Fix manually and run: platypus svn export --continue
#   2. Abort: platypus svn export --abort
#   3. Force through: platypus svn export --push-conflicts
```

**SVN race condition:**

If someone else commits to SVN while you're exporting, `git svn dcommit` will fail
and leave you in a rebase state with conflicts:

```bash
platypus svn export
# SVN dcommit failed: someone else committed to SVN (race condition).
# You are now in a rebase state with conflicts.
# Options:
#   1. Resolve manually:
#      git status                      # See conflicted files
#      # ... fix conflicts ...
#      git add <files>                 # Stage fixes
#      git rebase --continue           # Complete rebase
#      platypus svn export --continue  # Resume export
#   2. Abort: platypus svn export --abort
#   3. Force through: platypus svn export --push-conflicts
```

The `--push-conflicts` option will:

- Apply patches with conflict markers where needed
- Automatically resolve dcommit race conditions by adding conflicts and continuing
- Prefix commit messages with `[CONFLICT]`
- Log conflicts to `.git/svngit-conflicts.log`
- Exit with code 2 (success with conflicts)

---

## Configuration Files

### .gitsubtrees

Tracks subtree configuration (like `.gitmodules` for submodules):

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = abc123...         # Last synced upstream commit
    preMergeParent = def456... # Monorepo commit BEFORE last sync
    splitSha = 789abc...         # Last split SHA (for incremental push)
```

**Config field lifecycle:**

```text
                    ┌───────────────────────────────────────────────────────────┐
                    │                Config Field Updates                       │
                    ├─────────────┬─────────────┬─────────────┬─────────────────┤
                    │   add       │   pull      │   push      │   sync          │
┌───────────────────┼─────────────┼─────────────┼─────────────┼─────────────────┤
│ upstream          │  SET        │  UPDATE     │  -          │  UPDATE         │
│ (upstream tip)    │  (fetched)  │  (fetched)  │             │  (pull phase)   │
├───────────────────┼─────────────┼─────────────┼─────────────┼─────────────────┤
│ preMergeParent    │  SET        │  UPDATE     │  UPDATE     │  UPDATE         │
│ (before merge)    │  (pre-add)  │  (pre-merge)│  (pre-join) │  (both phases)  │
├───────────────────┼─────────────┼─────────────┼─────────────┼─────────────────┤
│ splitSha          │  -          │  -          │  SET/UPDATE │  UPDATE         │
│ (split result)    │             │             │  (split)    │  (push phase)   │
└───────────────────┴─────────────┴─────────────┴─────────────┴─────────────────┘
```

---

## Command Quick Reference

| Command | Purpose |
|---------|---------|
| `platypus subtree add <prefix> <repo> [ref]` | Add new subtree |
| `platypus subtree pull <prefix>` | Pull upstream → mono |
| `platypus subtree push <prefix>` | Push mono → upstream |
| `platypus subtree sync <prefix>` | Pull then push |
| `platypus subtree status [prefix]` | Show sync status |
| `platypus subtree list` | List configured subtrees |
| `platypus svn update` | Update local SVN mirror from SVN server (read-only) |
| `platypus svn export` | Export origin/main to SVN (fetches origin; no origin push after the fact) |
| `platypus svn sync` | Fetch origin, export to SVN, push origin |
| `platypus svn export --continue` | Resume after conflict |
| `platypus svn export --abort` | Abort in-progress export |
