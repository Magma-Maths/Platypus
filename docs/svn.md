# Platypus SVN Commands

## Quick start (SVN)

`svn export` and `svn sync` fetch `origin/main` at the start; manual `git fetch origin` is optional.

```bash
# Manual control (SVN only, you push origin yourself)
platypus svn export
git push origin main

# One-shot (full workflow)
platypus svn sync
```

Workflow summary: update = refresh local SVN mirror and show pending commits; export = fetch origin/main, export to SVN, and merge back locally (no origin push); sync = export plus push `main` to origin.

---

<!-- BEGIN platypus-svn-help -->
<!-- The following help text block is automatically generated by scripts/update-commands-md from: /Users/edgarcosta/MIT Dropbox/Edgar/magma/Platypus/lib/platypus svn --help; do not edit this block manually. -->
```bash
Usage: platypus svn <command> [options]

Sync Git main branch to SVN without rewriting Git history.

Commands:
  update            Update local SVN mirror from SVN server (read-only)
  export            Fetch origin/main, export to SVN (does not push to Git origin)
  sync              Full workflow: fetch origin, export to SVN, push origin
  --continue        Resume after resolving a conflict
  --abort           Abort in-progress operation and clean up

Options:
  -h, --help         Show this help message
  -v, --verbose      Show verbose step-by-step output
  -q, --quiet        Suppress normal output
  -n, --dry-run      Don't push to SVN or update marker
  -d, --debug        Show git commands as they are executed
  -x                 Turn on Bash debugging (set -x)
  --push-conflicts   Continue through conflicts, push with conflict markers
  --version          Show version information

Environment Variables:
  REMOTE          Git remote name (default: origin)
  MAIN            Main branch to sync from (default: main)
  MARKER          Marker branch for tracking progress (default: svn-marker)
  SVN_REMOTE_REF  git-svn tracking ref (default: refs/remotes/git-svn)
  SVN_BRANCH      Local SVN mirror branch (default: svn)
  EXPORT_BRANCH   Temporary svn-export branch (default: svn-export)
  CONFLICT_LOG    Conflict log file (default: .git/platypus/svngit/conflicts.log)

Exit Codes:
  0   Success - no conflicts
  1   Error - operation failed
  2   Success with conflicts - needs attention

Conflict Tracking (for automation):
  - Commits with conflicts are prefixed with [CONFLICT] in commit messages
  - Git notes are added to commits that had conflicts
  - Conflicts are logged to CONFLICT_LOG file

Examples:
  # Update local SVN mirror from SVN server (read-only)
  platypus svn update

  # Export Git commits to SVN server (does not push to Git origin)
  platypus svn export --verbose

  # Full workflow (fetch + SVN export + push origin)
  platypus svn sync --verbose
  platypus svn sync --debug --dry-run
  platypus svn sync --push-conflicts

  # With custom environment
  REMOTE=upstream MAIN=master platypus svn sync

Automation example:
  platypus svn sync --push-conflicts --quiet
  case $? in
    0) echo "Success" ;;
    1) echo "Error" ;;
    2) echo "Conflicts need review" ;;
  esac

```
<!-- END platypus-svn-help -->

SVN commands sync the Git monorepo with an SVN repository using `git-svn`.
Changes flow: Git → SVN, and SVN metadata flows back into Git.

### First sync scenarios

- Fresh git-svn init, origin/main empty or only SVN mirror:
  - `git svn init <svn-url>`; `git svn fetch`
  - `git switch -C svn refs/remotes/git-svn`
  - `git switch -C main svn` (if empty) and push once: `git push origin main`
  - Run `platypus svn export` (or `platypus svn sync`, auto-fetches origin/main)

- Fresh git-svn init, origin/main already has commits:
  - `git svn init <svn-url>`; `git svn fetch`
  - `git switch -C svn refs/remotes/git-svn`
  - Optionally merge `svn` into `main` if you need SVN tip included, then push
  - Run `platypus svn export` (or `platypus svn sync`, auto-fetches origin/main)

## Export vs sync at a glance

| Command | Fetch origin | SVN export | Local merge | Push origin | Best for |
|---------|:------------:|:----------:|:-----------:|:-----------:|----------|
| `svn export` | ✓ | ✓ | ✓ | - | CI with pre-fetch, manual control |
| `svn sync` | ✓ | ✓ | ✓ | ✓ | One-command convenience |

## Conceptual Overview

```text
┌────────────────────────────────────────────────────────────────────────┐
│                              GIT                                        │
│                                                                         │
│   origin/main ──────────────────────────────────────────► TIP          │
│                                                                         │
│   origin/svn-marker ──► Last exported commit                           │
│                                                                         │
│   svn branch ──────────────────────────────────────────► SVN mirror    │
│                         (tracks refs/remotes/git-svn)                   │
└────────────────────────────────────────────────────────────────────────┘
                              │
                              │ git svn dcommit / rebase
                              ▼
┌────────────────────────────────────────────────────────────────────────┐
│                              SVN                                        │
│                                                                         │
│   trunk ─────────────────────────────────────────────────────────────  │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

---

## svn update

**Purpose:** Update the local SVN mirror from the SVN server (read-only).

**Usage:**

```bash
platypus svn update
```

**What it does:**

1. Fetches latest state from the Git remote (for marker tracking)
2. Updates the SVN mirror using `git svn rebase`
3. Reports how many commits are pending to export

**Before:**

```text
Git main:   A ─── B ─────────────────────
                                          
SVN mirror: A ───────────────────────────
                                          
SVN trunk:  r1 ─── r2 (new SVN commit)   
```

**After:**

```text
Git main:   A ─── B ─────────────────────
                                          
SVN mirror: A ─── C (from r2) ───────────
                  │                       
                  └── git svn rebase pulled this
                                          
SVN trunk:  r1 ─── r2                    
```

The `svn` branch now has the new SVN revision as a Git commit.

---

## svn export

**Purpose:** Export commits from `origin/main` to SVN and merge back locally. Auto-fetches origin; does not push to origin.

**Usage:**

```bash
platypus svn export [--push-conflicts]
```

**What it does:**

1. Fetches latest `origin/main`
2. Updates the SVN mirror (`git svn rebase`)
3. Ensures the marker branch exists
4. Builds the export plan (first-parent only)
5. Applies each commit to the export branch, preserving metadata (handles conflicts)
6. Runs `git svn dcommit` to push to SVN
7. Advances the marker branch
8. Merges SVN changes back into `main`
9. Returns you to your original branch

**Notes:**

- Auto-fetches `origin/main` at the start
- Does **not** push to origin; run `git push origin main` yourself after review

**Why first-parent only?**

When you have subtrees, their history lives \"behind\" merge commits:

```text
main (first-parent path): A ─── B ─── C
                                │
                                └──┬── L1 ─── L2 (subtree history)
                                   │
                                   └── subtree merge brings in L1, L2
```

Walking `--first-parent` gives: A → B → C (3 commits)
Walking all parents gives: A → B → L1 → L2 → C (5 commits)

We only want to export the net changes, not replay subtree internal history.

**Before:**

```text
Git main:   A ─── B ─── C ──────────────── (marker at A)
                                           
SVN trunk:  r1 ─────────────────────────── 
```

**After:**

```text
Git main:   A ─── B ─── C ─── D (merge SVN back)  (marker at C)
                             ╱                     
SVN trunk:  r1 ─── r2 ─── r3 ────────────────────
            │      │      │
            │      │      └── from C
            │      └── from B
            └── from A (initial)
```

The marker now points to C, and main has a merge commit with SVN metadata.

---

## svn sync

**Purpose:** Full workflow convenience: fetch origin, export to SVN, merge back, and push `main` to origin.

**Usage:**

```bash
platypus svn sync [--push-conflicts]
```

**What it does:**

1. Fetches latest `origin/main`
2. Runs the `svn export` pipeline described above
3. Pushes `main` to origin

**Typical workflow:**

```bash
platypus svn sync              # full automation
platypus svn sync --push-conflicts
```

### Troubleshooting

- Origin push rejected (non-fast-forward):

```bash
git fetch origin
git rebase origin/main
git push origin main
```

- SVN dcommit race (left in rebase with conflicts):

```bash
git status           # fix conflicts
git add <files>
git rebase --continue
platypus svn export --continue
```

- Stale marker after rewritten history:

```bash
git push origin $(git merge-base origin/main svn):refs/heads/svn-marker --force
```

---

## Environment Variables (SVN)

| Variable | Default | Description |
|----------|---------|-------------|
| `REMOTE` | `origin` | Git remote name |
| `MAIN` | `main` | Main branch to sync from |
| `MARKER` | `svn-marker` | Progress tracking branch |
| `SVN_REMOTE_REF` | `refs/remotes/git-svn` | git-svn tracking ref |
| `SVN_BRANCH` | `svn` | Local SVN mirror branch |
| `EXPORT_BRANCH` | `svn-export` | Temporary export branch |
