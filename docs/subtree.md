# Platypus Subtree Commands

Subtree commands manage Git subtrees - embedding external repositories as
subdirectories in your monorepo. Configuration is stored in `.gitsubtrees`.

## Quick start (Subtree)

```bash
# Add a new subtree from a remote
platypus subtree add lib/foo git@github.com:owner/foo.git main

# Pull upstream changes into the subtree
platypus subtree pull lib/foo

# Push local subtree changes to upstream
platypus subtree push lib/foo

# Bidirectional sync (pull then push)
platypus subtree sync lib/foo
```

<!-- BEGIN platypus-subtree-help -->
<!-- The following help text block is automatically generated by scripts/update-commands-md from: /Users/edgarcosta/MIT Dropbox/Edgar/magma/Platypus/lib/platypus subtree --help; do not edit this block manually. -->
```bash
Usage: platypus subtree <command> [options]

Manage Git subtrees in the monorepo. Configuration is stored in .gitsubtrees
at the repository root (similar to .gitmodules).

Commands:
  create <prefix> <upstream> [-b <branch>]
                    Export existing directory to a new upstream repo
  init <prefix> [-r <remote>] [-b <branch>]
                    Link existing directory to an existing upstream
  add <prefix> <repo> [<ref>]
                    Add a new subtree from a remote repository
  pull <prefix>     Pull upstream changes into subtree
  push <prefix>     Push subtree changes to upstream
  sync <prefix>     Bidirectional sync (pull then push)
  status [<prefix>] Show sync status of subtree(s)
  list              List all configured subtrees

Options:
  -h, --help        Show this help message
  -v, --verbose     Show verbose output
  -q, --quiet       Suppress normal output
  -n, --dry-run     Show what would be done without doing it
  -d, --debug       Show debug output
  --version         Show version information

For create/init commands:
  -b, --branch      Remote branch (default: main)
  -r, --remote      Remote repository URL (init only)

Examples:
  # Export existing lib/foo to a new upstream repo
  platypus subtree create lib/foo git@github.com:owner/foo.git

  # Link existing lib/foo to an existing upstream
  platypus subtree init lib/foo -r git@github.com:owner/foo.git

  # Add a new subtree from a remote
  platypus subtree add lib/bar git@github.com:owner/bar.git main

  # Pull upstream changes
  platypus subtree pull lib/foo

  # Push local subtree changes to upstream
  platypus subtree push lib/foo

  # Bidirectional sync (pull then push)
  platypus subtree sync lib/foo

  # Show status of all subtrees
  platypus subtree status

Configuration file (.gitsubtrees):
  [subtree "lib/foo"]
      remote = git@github.com:owner/foo.git
      branch = main
      upstream = <last synced upstream commit>
      preMergeParent = <monorepo commit before last sync>
      splitSha = <last split SHA for incremental push>

```
<!-- END platypus-subtree-help -->

## Conceptual Overview (Subtree)

```text
┌─────────────────────────────────────────────────────────────────────┐
│                          MONOREPO                                   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  README.md                                                   │   │
│  │  src/                                                        │   │
│  │  lib/                                                        │   │
│  │  └── foo/  ◄─── SUBTREE (from upstream repo)                 │   │
│  │       ├── file.txt                                           │   │
│  │       └── lib-file.txt                                       │   │
│  │  .gitsubtrees  ◄─── Configuration file                       │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                              ▲
                              │ pull/push
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       UPSTREAM REPO                                 │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  file.txt                                                    │   │
│  │  lib-file.txt                                                │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Configuration Tracking

The `.gitsubtrees` file tracks three important SHA values for each subtree:

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = abc123...         # Last synced upstream commit
    preMergeParent = def456... # Monorepo commit BEFORE last sync  
    splitSha = 789abc...         # Last split result (for incremental push)
```

| Field | Purpose | Set By |
|-------|---------|--------|
| `upstream` | Points to the upstream repo commit we last synced with | `create`, `init`, `add`, `pull` |
| `preMergeParent` | Points to the monorepo commit BEFORE the sync operation | `create`, `init`, `add`, `pull`, `push` |
| `splitSha` | Points to the extracted subtree history branch tip | `create`, `push` |

**Command Summary:**

| Command | Use Case | Creates Dir? | Establishes Merge Base? |
|---------|----------|--------------|------------------------|
| `create` | Export existing dir to new upstream | No | Yes (via split --rejoin) |
| `init` | Link existing dir to existing upstream | No | Yes (via merge) |
| `add` | Add external repo as new subtree | Yes | Yes (via subtree add) |

**Why track these?**

- `upstream`: Tells us \"what upstream commit is our subtree based on?\" Used to detect if upstream has new changes.
- `preMergeParent`: Tells us \"where was the monorepo before this sync?\" This is a **stable reference** that doesn't change when we amend the merge commit to include config. Used for detecting new changes since last sync.
- `splitSha`: Enables **incremental push optimization**. Without it, `git subtree split` must walk the entire repo history. With it, we can use `--rejoin` to mark split points, making subsequent splits much faster.

---

## subtree create

**Purpose:** Export an existing directory to a new upstream repository.

**Use Case:** You have a directory in your monorepo (e.g., from SVN migration) and want
to make it available as a standalone repository for external contributors.

**Usage:**

```bash
platypus subtree create <prefix> <upstream> [-b <branch>]
```

**What it does:**

1. Validates the directory exists
2. Tests that the upstream repository is accessible
3. Runs `git subtree split --prefix --rejoin` to extract history and create merge base
4. Pushes the split branch to the upstream repository
5. Creates configuration in `.gitsubtrees`
6. Amends the rejoin commit to include config

**Before:**

```text
Mono:     A ─── B ─── C (contains lib/foo directory)
                                                     
Upstream: (empty repo, waiting for content)          
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (split --rejoin merge)
                           ╱
                    X ────┘  (extracted lib/foo history)
                    │
Upstream:           X        (pushed to upstream)

Config: upstream=X, preMergeParent=C, splitSha=X
```

**Config state after `create`:**

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = X              # ← The split/pushed commit
    preMergeParent = C      # ← Mono commit BEFORE the rejoin
    splitSha = X              # ← Same as upstream (enables incremental push)
```

---

## subtree init

**Purpose:** Link an existing directory to an existing upstream repository.

**Use Case:** The directory already has content, and there's an existing upstream repo
(perhaps already set up by someone else). This establishes the merge base so future
pulls work correctly.

**Usage:**

```bash
platypus subtree init <prefix> [-r <remote>] [-b <branch>]
```

**What it does:**

1. Validates the directory exists
2. Fetches from the upstream repository
3. Merges with `--allow-unrelated-histories` to establish subtree relationship
4. Creates configuration in `.gitsubtrees`
5. Amends the merge commit to include config

**Before:**

```text
Mono:     A ─── B ─── C (contains lib/foo, unrelated to upstream)
                                                     
Upstream: X ─── Y ─── Z (existing upstream content)
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (Merge to establish relationship)
                           ╱
Upstream: X ─── Y ─── Z ──┘

Config: upstream=Z, preMergeParent=C, splitSha=(none)
```

**Config state after `init`:**

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = Z              # ← Current upstream tip
    preMergeParent = C      # ← Mono commit BEFORE the merge
    splitSha = (none)         # ← Not set until first push
```

---

## subtree add

**Purpose:** Add a new subtree from a remote repository (creates the directory).

**Use Case:** You want to incorporate an external repository as a subdirectory in your
monorepo. The directory doesn't exist yet - it will be created with the upstream content.

**Usage:**

```bash
platypus subtree add <prefix> <repo> [<ref>]
```

**What it does:**

1. Fetches the remote repository
2. Adds the content at the specified prefix using `git subtree add`
3. Creates configuration in `.gitsubtrees`
4. Records the upstream commit SHA for tracking

**Before:**

```text
Mono:     A ─────────────────────────────────────
                                                  
Upstream: X (content we want)                     
```

**After:**

```text
Mono:     A ───── B (Add lib/foo subtree)
                 /
Upstream: X ────┘
```

**Config state after `add`:**

```ini
[subtree "lib/foo"]
    remote = git@github.com:owner/foo.git
    branch = main
    upstream = X              # ← The upstream commit we added
    preMergeParent = A      # ← Mono commit BEFORE the merge (stable!)
    splitSha = (none)         # ← Not set until first push
```

---

## subtree pull

**Purpose:** Pull upstream changes into the subtree.

**Usage:**

```bash
platypus subtree pull <prefix>
```

**What it does:**

1. Fetches from the configured remote
2. Merges upstream changes into the subtree prefix using `git subtree merge`
3. Updates the `upstream` and `parent` config values
4. Amends the merge commit to include config changes

**Before:**

```text
Mono:     A ─── B ─── C (mono work)
             ╱
Upstream: X ─── Y ─── Z (new commits)

Config: upstream=X, preMergeParent=A, splitSha=(none)
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (Merge subtree from Z)
             ╱             ╱
Upstream: X ─── Y ─── Z ──┘

Config: upstream=Z, preMergeParent=C, splitSha=(none)
                 ▲                   ▲
                 │                   └── Captured BEFORE the merge (stable!)
                 └── Updated to fetched upstream tip
```

The merge commit D contains:

- All files from Z in the `lib/foo/` prefix
- Updated `.gitsubtrees` with new `upstream` and `preMergeParent` SHAs

**Config changes:**

| Field | Before | After |
|-------|--------|-------|
| `upstream` | X | Z (new upstream tip) |
| `preMergeParent` | A | C (mono HEAD before merge) |
| `splitSha` | (none) | (unchanged) |

---

## subtree push

**Purpose:** Push local subtree changes to the upstream repository.

**Usage:**

```bash
platypus subtree push <prefix>
```

**What it does:**

1. Runs `git subtree split --rejoin` to extract subtree history
2. Pushes the split branch to the upstream remote
3. Records the `splitSha` for incremental optimization
4. Amends the rejoin commit to include config update

**Before:**

```text
Mono:     A ─── B ─── C (changed lib/foo/file.txt)
             ╱
Upstream: X ───────────

Config: upstream=X, preMergeParent=B, splitSha=(none)
```

**The split operation extracts subtree commits:**

```text
Full mono history:        Extracted subtree history:
A ─── B ─── C             X ─── C' (just the lib/foo changes)
     ╱                         │
    X                          └── This becomes splitSha
```

**After:**

```text
Mono:     A ─── B ─── C ─── D (rejoin merge)
             ╱             ╲
Upstream: X ─────────────── C' (pushed)
                            │
                            └── splitSha points here

Config: upstream=X, preMergeParent=C, splitSha=C'
                                    ▲            ▲
                                    │            └── NEW: tracks split result
                                    └── Captured BEFORE rejoin (stable!)
```

The `--rejoin` creates a merge commit marking where we split. This makes
subsequent pushes faster because `git subtree split` can skip already-processed history.

**Config changes:**

| Field | Before | After |
|-------|--------|-------|
| `upstream` | X | X (unchanged - we pushed TO upstream, not pulled) |
| `preMergeParent` | B | C (mono HEAD before rejoin) |
| `splitSha` | (none) | C' (the extracted subtree branch tip) |

**Why splitSha matters:**

Without splitSha tracking (first push):

```bash
git subtree split --prefix=lib/foo
# Must walk ENTIRE repo history to find subtree commits
# On a 50k commit repo, this can take minutes
```

With splitSha tracking (subsequent pushes):

```bash
git subtree split --prefix=lib/foo --rejoin
# The --rejoin merge commit marks the split point
# Subsequent splits only process new commits
# Takes seconds instead of minutes
```

---

## subtree sync

**Purpose:** Bidirectional sync - pull then push.

**Usage:**

```bash
platypus subtree sync <prefix>
```

**What it does:**

1. Executes `subtree pull` (get upstream changes)
2. Executes `subtree push` (send local changes)

This is useful when both the monorepo and upstream have new commits.

**Before (divergent state):**

```text
Mono:     A ─── B ─── C (mono change)
             ╱
Upstream: X ─── Y (upstream change)

Config: upstream=X, preMergeParent=A, splitSha=(none)
```

**After pull phase:**

```text
Mono:     A ─── B ─── C ─── D (merge from upstream)
             ╱             ╱
Upstream: X ─── Y ────────┘

Config: upstream=Y, preMergeParent=C, splitSha=(none)
```

**After push phase:**

```text
Mono:     A ─── B ─── C ─── D ─── E (rejoin)
             ╱             ╱     ╲
Upstream: X ─── Y ────────┴───── C' (mono change pushed)
                                  │
                                  └── splitSha

Config: upstream=Y, preMergeParent=D, splitSha=C'
```

**Full config evolution during sync:**

| Phase | upstream | preMergeParent | splitSha |
|-------|----------|------------------|----------|
| Before | X | A | (none) |
| After pull | Y | C | (none) |
| After push | Y | D | C' |

After sync, both repos have all changes:

- Upstream has: X → Y → C' (both upstream's Y and mono's C)
- Mono has: merged Y from upstream, plus its own C
